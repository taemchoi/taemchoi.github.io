---
title: "k8s - Lifecycle(Status, ReadinessProbe, LivenessProbe, QoS Classes, Node Scheduling)"
tags: [k8s]
categories:
  - docker-k8s
date: 2022-07-06

toc : true
---

## Pod의 Lifecycle 
### Pod Statues
- pod를 생성하면 나오는 상태정보
#### 1. Phase
- Pending : 파드의 최초 상태, 
- Running : 컨테이너가 최초 생성이 완료되면 Running으로 바뀜(내부 컨테이너가 돌아가지 않을 경우에도 Running이다.)
- Succeeded : Job으로 돌 경우, 정상적으로 완료되면 succeeded
- Failed : Job으로 돌 경우, 실패하면 Failed, pending중에 Failed가 되기도 함
- Unknown : network장애가 생기면 unknown으로 됨
  
#### 2. Conditions
- Type
    - Initialized : Pending상태일 경우, initContainer 옵션이 있을 경우, 이를 성공할 경우 True, 실패할 경우 False 
    - PodScheduled : 어느 노드에 Pod를 생성할지 정하는 것, 이게 끝나야 initalized가 진행 됨
    - ContainerReady : 파드가 Running이어도 컨테이너는 작동중이지 않을 수 있기 때문에 이를 확인해야함. 컨테이너가 돌아야 True
    - Ready : 파드가 Running이어도 컨테이너는 작동중이지 않을 수 있기 때문에 이를 확인해야함. 컨테이너가 돌아야 True(일반적으로 서비스가 유지되어야할 경우, 항상 모니터링 해줘야함)

- Reason : Status가 False일 경우, 이유를 설명
    - ContainersNotReady : 컨테이너 쪽 작업이 진행중이다.
    - PodCompleted  

#### 3. containerStatuses
- State 
    - Wating : 이미지 다운로드 중일 경우, True
    - Running : 정상 작동 중
    - Terminated : 종료

- Reason
    - ContainerCreating : 이미지 다운로드 중일 경우, True
    - CrashLoopBackOff : 컨테이너가 문제가 생겨서 재시작 될 경우 
    - Error 
    - Completed

### ReadnessProbe와 LivenessProbe
- 둘다 최초 pod를 생성할 때, app을 모니터링하여 안정적으로 운영하기 위해 사용된다.
- 예시 : 한 서비스에 두 개의 노드의 각 파드로 서비스를 하고 있다고 한다면 Traffic은 50%씩 나눠서 서비스되고 있을 것이다.
그런데 노드 하나가 죽으면 다른 노드에 100% 트래픽이 걸리고 이 트래픽을 기존 노드가 견디는 동안 새로운 노드에 파드를 만들게 된다.
파드가 러닝 상태가 되면 app이 구동됬는지와 상관없이 트래픽이 걸리게 되고 그러면 오류가 발생하게 되니 ReadinessProbe를 걸어 놓으면 app이 완전히 구동되야 트래픽이 분산되게 된다.
그런데 이 app이 오류에 의해 죽게되면 파드는 러닝이므로 트래픽 에러는 다시 발생하게 되는데 이럴 경우, 지속되는 오류를 방지하기 위해 앱을 감지하여 파드를 재시작시켜주도록 하는 것이 livenessProbe이다.

#### ReadnessProbe, LivenessProbe 옵션
컨테이너가 러닝상태가 되면 시작되게 됨
- httpGet : port, host, path, httpHeader, Scheme 으로 app을 체크
- Exec : 특정 명령어를 날려서 그에 따른 결과 체크
- tcpSocket : port, host를 확인하여 app체크
- initialDelaySeconds : 최초 대기 시간
- periodSeconds : 시간 간격으로 체크
- timeoutSeconds : 몇 초내로 결과가 안날아오면 failed로 알지
- successThreshold : 몇 번 성공해야 성공으로 간주할지
- failureThreshold : 몇 번 실패해야 실패로 간주할지


### 
- 노드에 파드가 3개 있고 균등하게 자원을 사용 중이다. 근데 파드 1에 추가 리소스가 필요하다면 앱의 중요도에 따라 자원을 당겨오게 된다.
- 가장 먼저 BestEffort가 다운되고 Burstable이 다음에 다운되고 마지막에 Guaranteed가 다운되게 된다.
    - BestEffort : Pod에 어떤 컨테이너 내에도 request와 limit이 설정되어 있지 않은 경우
    - Burstable : Pod에 컨테이너들이 모두 request와 limit은 설정되어 있으나 두 개의 값이 같지 않은 경우(Burstable 내부에서 삭제 순위는 OOM스코어를 보고 파드를 먼저 제거하게 되는데 가용률이 높은 파드부터 삭제가 됨)
    - Guaranteed : Pod에 컨테이너들이 모두 request와 limit가 설정되어 있고 컨테이너 내의 request와 limit값이 서로 같은 경우

